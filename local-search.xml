<?xml version="1.0" encoding="utf-8"?>
<search>
  
  
  
  <entry>
    <title>Authenticating in .NET Framework may fail after installing Windows security updates</title>
    <link href="/2022/04/05/Authenticating-in-NET-Framework-may-fail-after-installing-Windows-security-updates/"/>
    <url>/2022/04/05/Authenticating-in-NET-Framework-may-fail-after-installing-Windows-security-updates/</url>
    
    <content type="html"><![CDATA[<p>When using the DirectoryEntry, PrincipalContext, or LdapConnection classes, you may receive a failure indicating the credentials are invalid after installing the January 11, 2022 and later security updates.</p><p>Protections for CVE-2022-21920 are included in the referenced updates.  These updates contain improved logic to detect downgrade attacks for 3-part Service Principal Names when using the Microsoft Negotiate authentication protocol.</p><p>This article provides guidance for .NET Framework developers using the above referenced classes returning an invalid user name or password failure after the January 11, 2022 updates.  This occurs when accessing the <a href="https://docs.microsoft.com/en-us/dotnet/api/system.directoryservices.directoryentry.nativeobject?view=netframework-4.8#system-directoryservices-directoryentry-nativeobject">NativeObject</a> property on <a href="https://docs.microsoft.com/en-us/dotnet/api/system.directoryservices.directoryentry?view=netframework-4.8">DirectoryEntry</a>, using the <a href="https://docs.microsoft.com/en-us/dotnet/api/system.directoryservices.accountmanagement.principalcontext?view=netframework-4.8">PrincipalContext</a> (such as creating a <a href="https://docs.microsoft.com/en-us/dotnet/api/system.directoryservices.accountmanagement.userprincipal?view=netframework-4.8">UserPrincipal</a>), or calling Bind in <a href="https://docs.microsoft.com/en-us/dotnet/api/system.directoryservices.protocols.ldapconnection.bind?view=netframework-4.8">LdapConnection</a>.  This behavior has been observed in .NET Framework 4.5 through 4.8 but may affect other versions.</p><h2 id="More-Information"><a href="#More-Information" class="headerlink" title="More Information"></a>More Information</h2><p>In these cases the code and users being used to authenticate to Active Directory have not changed, but get the authentication failure after installing the January 11, 2022 and later Windows updates.  For these environments, it is likely that Kerberos authentication for 3-part SPNs has not worked for some time.  Where Windows would fallback to NTLMv2 previous to the updates, it will now permanently fail.</p><h4 id="Typical-symptoms-when-running-into-this-issue-include"><a href="#Typical-symptoms-when-running-into-this-issue-include" class="headerlink" title="Typical symptoms when running into this issue include:"></a>Typical symptoms when running into this issue include:</h4><ul><li>Failures when using the NetBIOS domain name (CONTOSO\username) but success when using the FQDN domain name, the UPN (<code>contoso.com\username</code> or <code>username@contoso.com</code>), or the username by itself</li><li>Failures when Using <a href="https://docs.microsoft.com/en-us/dotnet/api/system.directoryservices.protocols.authtype?view=netframework-4.8">AuthType</a>.Negotiate or AuthType.Kerberos with LdapConnection, but success when using AuthType.Ntlm</li><li>LSA event 40970 indicating an SPN that may already be applied to the DC used for authentication (does not appear for every attempt)</li></ul><h4 id="Stacks-where-a-related-exception-is-thrown-will-be-similar-to-those-below"><a href="#Stacks-where-a-related-exception-is-thrown-will-be-similar-to-those-below" class="headerlink" title="Stacks where a related exception is thrown will be similar to those below:"></a>Stacks where a related exception is thrown will be similar to those below:</h4><p><strong>DirectoryEntry:</strong></p><figure class="highlight stylus"><table><tr><td class="gutter"><div class="code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div></td><td class="code"><pre><code class="hljs stylus">System<span class="hljs-selector-class">.Runtime</span><span class="hljs-selector-class">.InteropServices</span><span class="hljs-selector-class">.COMException</span>: The user name or password is incorrect.  (hr=<span class="hljs-number">0</span>x8007052E)<br>    at System<span class="hljs-selector-class">.DirectoryServices</span><span class="hljs-selector-class">.DirectoryEntry</span><span class="hljs-selector-class">.Bind</span>(Boolean throwIfFail)<br>    at System<span class="hljs-selector-class">.DirectoryServices</span><span class="hljs-selector-class">.DirectoryEntry</span><span class="hljs-selector-class">.Bind</span>()<br>    at System<span class="hljs-selector-class">.DirectoryServices</span><span class="hljs-selector-class">.DirectoryEntry</span><span class="hljs-selector-class">.get_NativeObject</span>()<br>    <span class="hljs-selector-attr">[…]</span><br></code></pre></td></tr></table></figure><p><strong>LdapConnection:</strong></p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs stylus">System<span class="hljs-selector-class">.DirectoryServices</span><span class="hljs-selector-class">.Protocols</span><span class="hljs-selector-class">.LdapException</span>: The supplied credential is invalid.  (hr=<span class="hljs-number">0</span>x80131500)<br>    at System<span class="hljs-selector-class">.DirectoryServices</span><span class="hljs-selector-class">.Protocols</span><span class="hljs-selector-class">.LdapConnection</span><span class="hljs-selector-class">.BindHelper</span>(NetworkCredential newCredential, Boolean needSetCredential)<br>    at System<span class="hljs-selector-class">.DirectoryServices</span><span class="hljs-selector-class">.Protocols</span><span class="hljs-selector-class">.LdapConnection</span><span class="hljs-selector-class">.Bind</span>()<br>    <span class="hljs-selector-attr">[…]</span><br></code></pre></td></tr></table></figure><p><strong>PrincipalContext:</strong></p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs stylus">System<span class="hljs-selector-class">.DirectoryServices</span><span class="hljs-selector-class">.AccountManagement</span><span class="hljs-selector-class">.PrincipalServerDownException</span>: The server could not be contacted.  (hr=<span class="hljs-number">0</span>x80131501)<br>    at System<span class="hljs-selector-class">.DirectoryServices</span><span class="hljs-selector-class">.AccountManagement</span><span class="hljs-selector-class">.PrincipalContext</span><span class="hljs-selector-class">.ReadServerConfig</span>(String serverName, ServerProperties&amp; properties)<br>    at System<span class="hljs-selector-class">.DirectoryServices</span><span class="hljs-selector-class">.AccountManagement</span><span class="hljs-selector-class">.PrincipalContext</span><span class="hljs-selector-class">.DoServerVerifyAndPropRetrieval</span>()<br>    at System<span class="hljs-selector-class">.DirectoryServices</span><span class="hljs-selector-class">.AccountManagement</span><span class="hljs-selector-class">.PrincipalContext</span>.<span class="hljs-selector-class">.ctor</span>(ContextType contextType, String name, String container, ContextOptions options, String userName, String password)<br>    at System<span class="hljs-selector-class">.DirectoryServices</span><span class="hljs-selector-class">.AccountManagement</span><span class="hljs-selector-class">.PrincipalContext</span>.<span class="hljs-selector-class">.ctor</span>(ContextType contextType)<br>    <span class="hljs-selector-attr">[…]</span><br></code></pre></td></tr></table></figure><h2 id="Action"><a href="#Action" class="headerlink" title="Action"></a>Action</h2><p>Microsoft recommends that you triage why Kerberos authentication is failing.  More information can be found in <a href="https://support.microsoft.com/en-us/topic/kb5011233-protections-in-cve-2022-21920-may-block-ntlm-authentication-if-kerberos-authentication-is-not-successful-dd415f99-a30c-4664-ba37-83d33fb071f4">KB5011233: Protections in CVE-2022-21920 may block NTLM authentication if Kerberos authentication is not successful (microsoft.com)</a>.  Microsoft does not recommend favoring NTLM over Kerberos under any circumstance, so all actions should be geared towards getting Kerberos properly working.</p><h4 id="Notes"><a href="#Notes" class="headerlink" title="Notes"></a>Notes</h4><ul><li>Kerberos is strongly preferred over any version of NTLM.</li><li>The UPN format for usernames is preferred as the most reliable way to ensure Kerberos works.  The fallback to NTLM still occurs when using a 2-part SPN however, so Kerberos may still be failing even if authentication is successful.  Check the Logon event (ID 4624) in the Security event log on the DCs to be sure.  The Detailed Authentication Information will show which authentication method was used.</li><li>While post-update Windows will not fallback to NTLM, the search for the KCD will fallback from DNS to NetBIOS.  NetBIOS will fist check its cache, the lmhosts file, WINS, and then finally will broadcast on the broadcast address for the network.  NetBIOS works, but DNS is preferred.</li><li>The DNS SRV record for Kerberos is generally in the format <code>_kerberos._tcp._siteName._sites.dc._msdcs._domain</code>, where <code>_domain</code> is the full domain, including any child domains.  e.g. <code>_kerberos._tcp.defaultfirstsitename._sites.dc._msdcs.child1.contoso.com</code></li><li>DNS lookups will use the DNS suffix list in the TCP&#x2F;IP settings for each network card, on the WINS tab.</li><li>If the NetBIOS domain name is not the same as the DNS domain name, the DNS suffix list will not work, as the resulting DNS name will not exist.</li><li>NetBIOS lookups require that NetBIOS over TCP&#x2F;IP is enabled on the WINS tab of the TCP&#x2F;IP settings page for the target NIC, and the TCP&#x2F;IP NetBIOS Helper service is running.</li><li>NetBIOS lookups are performed using a network broadcast.  Windows will send a NetBIOS request for a DC responsible for the given domain name, and each DC will respond itself.  The DCs must be able to see the broadcast to respond, and in turn must also have NetBIOS enabled.</li><li>The port for NetBIOS is 137.</li></ul>]]></content>
    
    
    
    <tags>
      
      <tag>dotNet</tag>
      
      <tag>authentication</tag>
      
      <tag>security</tag>
      
    </tags>
    
  </entry>
  
  
  
  
</search>
